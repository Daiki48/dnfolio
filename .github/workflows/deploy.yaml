on:
  push:
      tags:
        - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      deployments: write
    name: Deploy to Cloudflare Workers from GitHub Actions                                                            
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 23.8.0
      - name: Build
        run: cargo run -- build
      - name: Deploy                                                                                                  
        uses: cloudflare/wrangler-action@v3                                                                           
        with:                                                                                                         
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}                                                               
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}                                                             
          command: deploy
      - name: Generate Release Notes
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi

          # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
          CONTENT=$(git log --pretty=format:"%s" $RANGE | grep "^:+1:" | sed 's/:+1: /- /' || true)
          FEATURES=$(git log --pretty=format:"%s" $RANGE | grep "^:zap:" | sed 's/:zap: /- /' || true)
          BUGFIXES=$(git log --pretty=format:"%s" $RANGE | grep "^:bug:" | sed 's/:bug: /- /' || true)
          STYLES=$(git log --pretty=format:"%s" $RANGE | grep "^:art:" | sed 's/:art: /- /' || true)
          REFACTOR=$(git log --pretty=format:"%s" $RANGE | grep "^:recycle:" | sed 's/:recycle: /- /' || true)
          REMOVED=$(git log --pretty=format:"%s" $RANGE | grep "^:fire:" | sed 's/:fire: /- /' || true)
          CONFIG=$(git log --pretty=format:"%s" $RANGE | grep "^:hammer:" | sed 's/:hammer: /- /' || true)
          MOVED=$(git log --pretty=format:"%s" $RANGE | grep "^:truck:" | sed 's/:truck: /- /' || true)

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
          {
            echo "body<<EOF"
            [ -n "$FEATURES" ] && echo -e "## âœ¨ æ–°æ©Ÿèƒ½\n$FEATURES\n"
            [ -n "$CONTENT" ] && echo -e "## ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„\n$CONTENT\n"
            [ -n "$BUGFIXES" ] && echo -e "## ğŸ› ãƒã‚°ä¿®æ­£\n$BUGFIXES\n"
            [ -n "$STYLES" ] && echo -e "## ğŸ¨ UIæ”¹å–„\n$STYLES\n"
            [ -n "$REFACTOR" ] && echo -e "## â™»ï¸ ãƒªãƒ•ã‚¡ã‚¯ã‚¿\n$REFACTOR\n"
            [ -n "$CONFIG" ] && echo -e "## ğŸ”§ è¨­å®š\n$CONFIG\n"
            [ -n "$MOVED" ] && echo -e "## ğŸšš ç§»å‹•\n$MOVED\n"
            [ -n "$REMOVED" ] && echo -e "## ğŸ”¥ å‰Šé™¤\n$REMOVED\n"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.body }}
