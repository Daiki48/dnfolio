# dnfolio ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# Cloudflare Workers Assets ã«ãƒ‡ãƒ—ãƒ­ã‚¤
# - WASM ãƒ“ãƒ«ãƒ‰ï¼ˆwasm-packï¼‰
# - SSG ãƒ“ãƒ«ãƒ‰ï¼ˆcargo run -- buildï¼‰
# - wrangler deploy

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      deployments: write
    name: Deploy to Cloudflare Workers

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆwranglerç”¨ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 23

      # Rust ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå®‰å®šç‰ˆ + wasm32ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼‰
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      # Cargo ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # wasm-pack ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install wasm-pack
        run: |
          curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # WASM ãƒ“ãƒ«ãƒ‰ï¼ˆæœ¬ç•ªç”¨ã€ã‚µã‚¤ã‚ºæœ€é©åŒ–ï¼‰
      - name: Build WASM
        run: |
          cd crates/dnfolio-wasm
          wasm-pack build --target web --out-dir ../../dist --out-name dnfolio_wasm --release
          rm -f ../../dist/.gitignore ../../dist/package.json ../../dist/README.md

      # SSG ãƒ“ãƒ«ãƒ‰
      - name: Build SSG
        run: cargo run --release -p dnfolio-ssg -- build
        env:
          CF_ANALYTICS_TOKEN: ${{ secrets.CF_ANALYTICS_TOKEN }}

      # Cloudflare Workers ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.DNFOLIO_WORKERS_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy

      # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
      - name: Generate Release Notes
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi

          # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
          CONTENT=$(git log --pretty=format:"%s" $RANGE | grep "^:+1:" | sed 's/:+1: /- /' || true)
          FEATURES=$(git log --pretty=format:"%s" $RANGE | grep "^:zap:" | sed 's/:zap: /- /' || true)
          BUGFIXES=$(git log --pretty=format:"%s" $RANGE | grep "^:bug:" | sed 's/:bug: /- /' || true)
          STYLES=$(git log --pretty=format:"%s" $RANGE | grep "^:art:" | sed 's/:art: /- /' || true)
          REFACTOR=$(git log --pretty=format:"%s" $RANGE | grep "^:recycle:" | sed 's/:recycle: /- /' || true)
          REMOVED=$(git log --pretty=format:"%s" $RANGE | grep "^:fire:" | sed 's/:fire: /- /' || true)
          CONFIG=$(git log --pretty=format:"%s" $RANGE | grep "^:hammer:" | sed 's/:hammer: /- /' || true)
          MOVED=$(git log --pretty=format:"%s" $RANGE | grep "^:truck:" | sed 's/:truck: /- /' || true)

          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
          {
            echo "body<<EOF"
            [ -n "$FEATURES" ] && echo -e "## âœ¨ æ–°æ©Ÿèƒ½\n$FEATURES\n"
            [ -n "$CONTENT" ] && echo -e "## ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„\n$CONTENT\n"
            [ -n "$BUGFIXES" ] && echo -e "## ğŸ› ãƒã‚°ä¿®æ­£\n$BUGFIXES\n"
            [ -n "$STYLES" ] && echo -e "## ğŸ¨ UIæ”¹å–„\n$STYLES\n"
            [ -n "$REFACTOR" ] && echo -e "## â™»ï¸ ãƒªãƒ•ã‚¡ã‚¯ã‚¿\n$REFACTOR\n"
            [ -n "$CONFIG" ] && echo -e "## ğŸ”§ è¨­å®š\n$CONFIG\n"
            [ -n "$MOVED" ] && echo -e "## ğŸšš ç§»å‹•\n$MOVED\n"
            [ -n "$REMOVED" ] && echo -e "## ğŸ”¥ å‰Šé™¤\n$REMOVED\n"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # GitHub Release ä½œæˆ
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.body }}
